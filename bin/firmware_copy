#!/bin/bash 

source $HATHOR/config/basic_config
source $HATHOR/lib/libfirmwareinfo
source $HATHOR/lib/libmessage

hathor_get_firmware_path


DIRECTORY_TO_PUT_FIRMWARE=$FIRMWARE_VERSION

FIRMWARE_TO_UPLOAD="`ls $RELEASE_DIR/$PRODUCTVER* $RELEASE_DIR/sd.rom`"
for f in $FIRMWARE_TO_UPLOAD; do
	PUT_COMMAND="put $f `basename $f`; $PUT_COMMAND"
done
SMB_CMD_FIRMWARE="mkdir $DIRECTORY_TO_PUT_FIRMWARE; cd $DIRECTORY_TO_PUT_FIRMWARE; $PUT_COMMAND; cd .."


RETRY_COUNT=2
info "準備將 firmware 和 history.txt 上傳至雅典娜"
warn "密碼錯誤重試次數只有 $RETRY_COUNT 次，請小心輸入"
read -s -p "密碼: " PASSWORD
echo 

export USER=$USERNAME_ATHENA
export PASSWD=$PASSWORD
# create directory
ret=`SMB_Command "$FIRMWARE_PATH_SERVER_REVERTED" "$HATHOR_FIRMWARE_PATH_PREFIX_REVERTED/" "$SMB_CMD_FIRMWARE"`
if [ "$ret" != "" ]; then
	warn "目錄 $DIRECTORY_TO_PUT_FIRMWARE 新增失敗! ($ret)"
	exit 1
fi

###  upload history.txt

# get correct history path first
hathor_get_history_path $FIRMWARE_PATH_SERVER_REVERTED $HATHOR_FIRMWARE_PATH_PREFIX_REVERTED $USERNAME_ATHENA $PASSWORD

export USER=$USERNAME_ATHENA
export PASSWD=$PASSWORD
SMB_CMD_HISTORY="get $HATHOR_FIRMWARE_HISTORY_NAME $HATHOR_FIRMWARE_HISTORY_NAME.bak; put $RELEASE_DIR/history.txt $HATHOR_FIRMWARE_HISTORY_NAME; put $HATHOR_FIRMWARE_HISTORY_NAME.bak"
ret=`SMB_Command "$FIRMWARE_PATH_SERVER_REVERTED" "$HATHOR_FIRMWARE_HISTORY_FOLDER" "$SMB_CMD_HISTORY"`
if [ "$ret" != "" ]; then
	warn "檔案上傳失敗! ($ret)"
	exit 1
fi

unset PASSWD; unset USER
