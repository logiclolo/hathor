#!/bin/sh

# This is hathor doctor speaking. I will check if everything need for hathor running are ok

NORMAL='\033[0m'
HIGHLIGHT='\033[1m'

AllPass=1

# check .rtrc
if [ ! -f $HOME/.rtrc ] ; then
	echo "RT rc file does not exist. I'm going to generate rtrc to $HOME/.rtrc"
	echo "Please input your id for logging to PMRT"
	read -p "PMRT ID:" pmrt_id
	echo "server http://dqa01/rt/" > "$HOME/.rtrc"
	echo "user $pmrt_id" >> "$HOME/.rtrc"
fi

# check .rt_sessions 
if [ ! -f $HOME/.rt_sessions ] ; then
	echo "Setup rt session. I'm going to make a test search to generate cookie for pmrt client."
	echo "Please enter PMRT username/password on request"
	rt ls subject='rt-doctor-query'
fi

# check .hathor/hathorrc
if [ ! -f $HOME/.hathor/hathorrc ] ; then
	echo "Hathor rc file does not exist. I'm going to generate hathorrc to $HOME/.hathor/hathorrc"
	echo "Please input your id for logging to VIVOTEK."
	echo "This information will be used when uploading firmware to athena."
	echo "For example, if your e-mail is klaymen.chang@vivotek.com,"
	echo -ne "then you should enter$HIGHLIGHT klaymen.chang$NORMAL\n"
	read -p "ID: " athena_id
	mkdir -p $HOME/.hathor
	echo "USERNAME_ATHENA=\"$athena_id\"" > "$HOME/.hathor/hathorrc"
fi

# check .bug_cookie
if [ ! -f $HOME/.bugz_cookie ] ; then
	echo "Setup bugzilla configuration. I'm going to make a test search to generate cookie for bugz."
	echo "Please enter bugzilla username/password on request"
	read -p "Username: " USERNAME
	read -s -p "Password: " PASSWORD
	bugz -q -u $USERNAME -p $PASSWORD -b http://dqa01/bugzilla/ search --product 'VVTK IP8332' > bugz_output
	if [ "$?" != "0" ] ; then
		cat bugz_output
		AllPass=0
	fi
	rm -f bugz_output
fi


if [ "$AllPass" == "1" ]; then
	echo "You are healthy."
else
	echo "Hathor config is not ready! Run \`make doctor' again to setup hathor"
fi
